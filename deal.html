<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程合約管理系統</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* 字型設定：讓預覽更像正式文件 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
        }

        .font-serif {
            font-family: 'Noto Serif TC', 'KaiTi', 'BiauKai', serif;
        }

        /* 列印樣式控制 */
        @media print {
            body {
                background: white;
            }
            .no-print {
                display: none !important;
            }
            .print-area {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none !important;
            }
            .contract-page {
                min-height: 297mm; /* A4 height */
                page-break-after: always;
            }
            /* 隱藏瀏覽器預設的頁首頁尾 */
            @page {
                margin: 15mm;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 圖示組件 (SVG) ---
        const IconWrapper = ({ children, size = 24, className = "", onClick }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
                onClick={onClick}
                style={onClick ? {cursor: 'pointer'} : {}}
            >
                {children}
            </svg>
        );

        const Printer = (props) => <IconWrapper {...props}><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></IconWrapper>;
        const Plus = (props) => <IconWrapper {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconWrapper>;
        const Edit = (props) => <IconWrapper {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></IconWrapper>;
        const Trash2 = (props) => <IconWrapper {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconWrapper>;
        const Eye = (props) => <IconWrapper {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></IconWrapper>;
        const ArrowLeft = (props) => <IconWrapper {...props}><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></IconWrapper>;
        const Save = (props) => <IconWrapper {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconWrapper>;
        const LayoutTemplate = (props) => <IconWrapper {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></IconWrapper>;
        const AlertCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></IconWrapper>;
        const Building = (props) => <IconWrapper {...props}><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="9" y1="22" x2="9" y2="12"></line><line x1="15" y1="12" x2="15" y2="22"></line><line x1="4" y1="12" x2="20" y2="12"></line></IconWrapper>;
        const X = (props) => <IconWrapper {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconWrapper>;
        const ChevronDown = (props) => <IconWrapper {...props}><polyline points="6 9 12 15 18 9"></polyline></IconWrapper>;


        // ==========================================
        // 資料與常數定義
        // ==========================================

        const PAYMENT_ONE_TIME = `六、 付款辦法:
1. 全部工程完成驗收合格後一次付款，付款以現金票方式給付。
2. 「承攬商各案場完成後我司驗收合格，每月10日/25日提供正本發票(郵寄以郵戳為憑)，我司驗收人員於收到申請後當月30日/次月15日，確認驗收無誤則進行匯款。」
3. 工程需全部完工，案場餘料及垃圾清運完畢，並經甲方派員驗收合格後，乙方才得向甲方請款，乙方請款時須同時附上甲方指定繳交的照片。驗收時請提交一個月內的材料購買證明單。`;

        const PAYMENT_ELECTRICAL = `六、 付款辦法:
1. 工程分階段請款，分為完工款、掛錶款與驗收款。
   (1) 完工款: 50%。
       (需提供照片：10張INV收貨； INV掛上後，序號及編號照片；簽收單正本；INV全景照片)工程需全部完工，並經甲方派員驗收合格後，乙方才得向甲方請款，乙方請款時須同時附上甲方指定繳交的照片，並清運案場雜物、垃圾。
   (2) 掛錶款: 30%。
       1.台電掛錶完成，現場量測電壓電流值符合設計規範(表格如附件2)。
       2.監控箱完成安裝，監控系統上線。
   (3) 驗收款: 20%。
       監控上線PR直達80％以上，清運案場雜物、垃圾及所有缺失修正完畢。
       驗收時請提收一個月內的材料購買證明單。
2. 「承攬商各案場完成後我司驗收合格，每月10日/25日提供正本發票(郵寄以郵戳為憑)，我司驗收人員於收到申請後當月30日/次月15日，確認驗收無誤則進行放款。」`;

        const PAYMENT_70_30 = `六、 付款辦法:
1. 全部工程完成驗收合格後分次付款，付款以現金票方式給付。(驗收時廠商需先提供完工照、全景照)
2. 乙方於二十五日前向甲方送交發票及請款單提出驗收，驗收合格後，甲方於完工次月15日(如遇假日，則順延至上班日)以現金票方式付款。若乙方於當月二十六日後送交發票及請款單予甲方者，付款日於次次月支付。
3. 工程分階段請款，分為完工款70%、驗收款30%。
   (1) 完工款70%：工程施作完成 (完工照)，案場雜物、垃圾清除完畢，依實際數量請領款項。
   (2) 總驗收款30%：三方總驗收通過後並清運案場雜物、垃圾及所有缺失修正完畢。
   工程需全部完工，並經甲方派員驗收合格後，乙方才得向甲方請款，乙方請款時須同時附上甲方指定繳交的照片；驗收時請提交一個月內的材料購買證明單。`;

        const PAYMENT_ROOFTOP = `六、付款辦法
1. 全部工程完成驗收合格後分次付款，付款以匯款方式給付。(驗收時廠商需先提供完工照、全景照)
2. 乙方於二十五日前向甲方送交發票及請款單提出驗收，驗收合格後，甲方於完工次月15日(如遇假日，則順延至上班日)以匯款方式付款。若乙方於當月二十六日後送交發票及請款單予甲方者，付款日於次次月支付。
3. 工程分階段請款，分為完工款70%、掛錶款20% 、三方總驗收款10% 。
   (1) 完工款70%：每項施工完成並經甲方指定人員現場驗收通過後，依實做實算比例請領 70%。(30張模組序號貼紙、 1張模組背面大貼紙、20張模組下貨)，現場驗收通過無重大缺失，並且完成現場雜物、垃圾清運。
   (2) 掛錶款20%：台電掛錶完成，現場監控箱完成安裝、系統上線，並通過驗收，可請領 20%。
   (3) 三方總驗收款10%：全部工程完成後，監控系統 PR 值達 80%以上，案場垃圾清運與缺失改善完畢後，可請領剩餘 10%。
   工程需全部完工，並經甲方派員驗收合格後，乙方才得向甲方請款，請款時需附上公司要求繳交的施工前、中、後所有的照片。`;

        const PAYMENT_GROUND_FULL = `六、 付款辦法:
1. 工程分階段請款，分為基礎完工款(一)、鋼構完工款(二)、模組安裝完工款(三)與驗收款(四)。
   (1) 基礎完工款(一): 20%。(需提供照片：施工前、中、後照片)基礎工程需全部完工(鋼筋、模板、混凝土)，並經甲方派員驗收合格後，乙方才得向甲方請款，乙方請款時須同時附上甲方指定繳交的照片，並清運案場雜物、垃圾。
   (2) 鋼構完工款(二): 30%。(需提供照片：施工前、中、後照片)太陽能鋼構組立需全部完工，並經甲方派員驗收合格後，乙方才得向甲方請款，乙方請款時須同時附上甲方指定繳交的照片，並清運案場雜物、垃圾。
   (3) 模組安裝完工款(三): 30%。(需提供照片：施工前、中、後照片)模組安裝需全部完工，並經甲方派員驗收合格後，乙方才得向甲方請款，乙方請款時須同時附上甲方指定繳交的照片，並清運案場雜物、垃圾。
   (4) 驗收款(四): 20%。驗收合格，清運案場雜物、垃圾及所有缺失修正完畢。
2. 乙方請款時應檢附當期全額發票。`;

        const PAYMENT_PC_PILE = `六、 付款辦法:
1. 全部工程完成驗收合格後分次付款，付款以現金票方式給付。
2. 「承攬商各案場完成後我司驗收合格，每月10日/25日提供正本發票(郵寄以郵戳為憑)，我司驗收人員於收到申請後當月30日/次月15日，確認驗收無誤則進行放款。」
3. 工程分階段請款，分為完工款 80%、驗收款 20% 。
   (1) 完工款80%：工程打樁完工(完工照)，案場雜物、垃圾清除完畢，依實際打設支數請領款項。
   (2) 驗收款20%：三方總驗收通過後並清運案場雜物、垃圾及所有缺失修正完畢。`;

        const PAYMENT_CONTRACT_ORDER = `本工程付款方式依下列規定辦理：
1. 本工程無預付款。
2. 完工日 7 天內結清貨款。
3. 乙方請款時應檢附當期全額發票。`;

        const ATTACH_STD = [
            "「附件一、混凝土提試體測試參考規範」", "「附件二、太陽光電系統施工要點」", "「附件三、承攬商環境安全衛生承諾書」", 
            "「附件四、勞工安全衛生施工規範」", "「附件五、屋頂作業墜落防治規範」", "「附件六、承攬作業危害告知及安全協議組織會議紀錄」"
        ];
        const ATTACH_ELEC = ["「附件一、最新電器圖說」", "「附件二、串併圖」", "「附件三、直流配電箱電性測試紀錄表」", "「附件四、案場餘料清單」"];
        const ATTACH_STEEL = ["「附件一、柱位圖」", "「附件二、出加工廠磅單」"];
        const ATTACH_PC_PILE = ["「附件一、銜配圖」", "「附件二、串並圖」", "「附件三、鋼構圖說」", "「附件四、案場餘料清單」", "「附件五、直流配電箱電性測試紀錄表」"];
        const ATTACH_MODULE = ["「附件一、電器圖說」", "「附件二、串並圖」", "「附件三、步道圖」", "「附件四、案場餘料清單」", "「附件五、直流配電箱電性測試紀錄表」"];
        const ATTACH_NONE = [];

        const OWNER_COMPANIES_DATA = [
            { name: '晶電能源系統股份有限公司', leader: '林碧麗', taxId: '64378445', address: '台南市安平區國平里健康三街148號9F-1' },
            { name: '宇軒能源科技股份有限公司', leader: '杜鎧兆', taxId: '53047270', address: '臺南市安平區國平里健康三街140號5樓之1' },
            { name: '晁星能源股份有限公司', leader: '許明馳', taxId: '42598803', address: '台南市安平區億載里永華11街17巷30號2F' },
            { name: '宇軒綠能股份有限公司', leader: '杜鎧兆', taxId: '64938186', address: '台南市安平區健康三街148號9樓之1' },
            { name: '兆明升股份有限公司', leader: '杜鎧兆', taxId: '90696995', address: '台南市安平區健康三街148號9樓之1' }
        ];

        const CONTRACTOR_COMPANIES_DATA = [
            { name: '連聖傑工程行', leader: '張淑娟', taxId: '45604976', address: '南投縣南投市軍功里東山路100號1樓', contact: '廖烽傑' },
            { name: '豐楙工程有限公司', leader: '林佳明', taxId: '24922737', address: '台南市後壁區菁豐里7-1號', contact: '林佳明' },
            { name: '喬翊工程有限公司', leader: '林欣諭', taxId: '00088888', address: '嘉義縣朴子市大葛里24鄰吉祥二街21號1樓', contact: '林欣諭' },
            { name: '全通水電工程行', leader: '陳坤利', taxId: '26444514', address: '台南市關廟區保東路288巷119號', contact: '陳坤利' },
            { name: '興榮工程行', leader: '唐邦瀚', taxId: '47952747', address: '台南市安南區同安路345號之3號', contact: '唐茂藤' },
            { name: '長秀工程行', leader: '李秋明', taxId: '88977428', address: '台南市佳里區安西里光華街142號1樓', contact: '李秋明' },
            { name: '優立環保工程企業行', leader: '未知', taxId: '36820621', address: '未知', contact: '鄧榆衡' },
            { name: '豐盈莊工程行', leader: '吳垂莊', taxId: '81214328', address: '臺南市柳營區果毅里果毅後60之17號1樓', contact: '張文州' },
            { name: '翰霆實業有限公司', leader: '葉桂娥', taxId: '60385198', address: '臺中市南屯區寶山里寶山東二街19巷7號3樓之1', contact: '葉桂娥' },
            { name: '康金綠能科技股份有限公司', leader: '謝慶儀', taxId: '53810330', address: '金門縣金寧鄉安美村湖南32-15號1樓', contact: '謝慶儀' },
            { name: '北玉嘉工程有限公司', leader: '鄒國明', taxId: '64908303', address: '台南市善化區文昌路143號', contact: '鄒國明' },
            { name: '旻昇企業有限公司', leader: '吳國禎', taxId: '64990099', address: '台南市安南區安興街435巷33號', contact: '吳國禎' },
            { name: '亞士全球股份有限公司', leader: '葉集文', taxId: '24775290', address: '台北市內湖區文德路66巷63號', contact: '胡朝傑' },
            { name: '明欣電訊公司', leader: '張永興', taxId: '61953021', address: '嘉義縣民雄鄉中央村田中央36-1號', contact: '張永興' },
            { name: '昱德機電工程有限公司', leader: '蔡朝琴', taxId: '83573215', address: '台南市歸仁區文化路16街42巷20號', contact: '蔡朝琴' },
            { name: '晨曦能源股份有限公司', leader: '盧文凱', taxId: '55767652', address: '台北市萬華區康定路60號8樓之6', contact: '盧文凱' },
            { name: '源埔國際工程', leader: '劉明佳', taxId: '91155158', address: '花蓮縣吉安鄉南埔十三街176號1F', contact: '劉明佳' },
            { name: '崇源電工程行', leader: '黃崇源', taxId: '47689367', address: '高雄市楠梓區啟昌街55號', contact: '黃崇源' },
            { name: '耀巨能源科技股份有限公司', leader: '李坤耀', taxId: '91057311', address: '雲林縣麥寮鄉海豐村義和路16-1號', contact: '李坤耀' },
            { name: '日騰能源科技有限公司', leader: '簡建雄', taxId: '42970605', address: '嘉義縣朴子市大槺鄉962號', contact: '簡建雄' },
            { name: '松燁工程行', leader: '李明修', taxId: '', address: '', contact: '李明修' },
            { name: '建昌土木包工業', leader: '黃建誌', taxId: '25747954', address: '台南市將軍區保源里111-6號', contact: '黃建誌' },
            { name: '上梁科技有限公司', leader: '洪啓源', taxId: '13155195', address: '高雄市左營區文自路393號1樓', contact: '洪啓源' },
            { name: '一興工程行', leader: '羅智宗', taxId: '40170901', address: '臺中市東勢區新盛里新盛街４７６號１樓', contact: '羅智宗' },
            { name: '巨強工程行', leader: '李仕賢', taxId: '89018876', address: '台南市永康區中華路144之1B1', contact: '李仕賢' },
            { name: '士鐸工程行', leader: '張佳榮', taxId: '00844315', address: '高雄市苓雅區福壽街145巷21號3樓', contact: '張佳榮' },
            { name: '展協企業社', leader: '胡碩麟', taxId: '72031707', address: '高雄市小港區高鳳路４５９巷１弄２號１５樓', contact: '胡碩麟' },
            { name: '信昇工程行', leader: '吳佳俊', taxId: '92653766', address: '宜蘭縣宜蘭市東村里縣民大道二段717號一樓', contact: '吳佳俊' },
            { name: '新農工程行', leader: '劉惠珠', taxId: '87109837', address: '台中市北區建興里德化街184之2號七樓之一', contact: '劉惠珠' },
            { name: '尚好重機工程有限公司', leader: '', taxId: '', address: '', contact: '' },
            { name: '秋福科技工程有限公司', leader: '許炎坤', taxId: '90858047', address: '台中市南區樹義里福田路77巷26號一樓', contact: '許炎坤' }
        ];

        const CONTRACT_TYPES = [
            { id: 'machinery', name: '機房架設合約', content: '機房架設工程', unit: '座', inputType: 'quantity', defaultPrice: 20000, payment: PAYMENT_ONE_TIME, attachments: ATTACH_STD },
            { id: 'electrical', name: '機電合約', content: '太陽能工程電氣系統承攬與施工掛錶', unit: 'KW', inputType: 'capacity', payment: PAYMENT_ELECTRICAL, attachments: ATTACH_ELEC, pricing: [{ max: 50, price: 1800 }, { max: 100, price: 1600 }, { max: 499, price: 1500 }, { max: Infinity, price: 1400 }] },
            { id: 'steel', name: '鋼構組立合約', content: '太陽能鋼構安裝組立', unit: '公斤', inputType: 'weight', defaultPrice: 0, type: 'steel_weight', payment: PAYMENT_70_30, attachments: ATTACH_STEEL },
            { id: 'heavy_steel', name: '重型H型鋼構加工', content: '重型H型鋼構加工', unit: '式', inputType: 'quantity', defaultPrice: 0, payment: PAYMENT_ONE_TIME, attachments: ATTACH_STD },
            { id: 'rooftop', name: '屋頂型鋼構/模組', content: '鋼構組立、模組及維修步道安裝及太陽能工程電氣系統承攬與施工掛錶', unit: 'KW', inputType: 'capacity', defaultPrice: 8000, payment: PAYMENT_ROOFTOP, attachments: ATTACH_STD },
            { id: 'module_walkway', name: '模組安裝及維修步道', content: '太陽能模組安裝及維修步道工程', unit: 'KW', inputType: 'capacity', defaultPrice: 500, payment: PAYMENT_70_30, attachments: ATTACH_MODULE },
            { id: 'corrugated_plate', name: '浪板合約', content: '屋頂浪板鎖附與防水施工', unit: 'KW', inputType: 'capacity', defaultPrice: 230, payment: PAYMENT_70_30, attachments: ATTACH_STD },
            { id: 'base_pier', name: '基礎座合約', content: '鋼筋、模板、混凝土工程施工', unit: '墩', inputType: 'quantity', payment: PAYMENT_70_30, attachments: ATTACH_STD, pricing: [{ max: 20, price: 18000 }, { max: 50, price: 15000 }, { max: Infinity, price: 15000 }] },
            { id: 'ground_base', name: '地面型-基礎工程', content: '地面型案場基礎施工工程', unit: 'KW', inputType: 'capacity', payment: PAYMENT_GROUND_FULL, attachments: ATTACH_STD, pricing: [{ max: 90, price: 4000 }, { max: 300, price: 3800 }, { max: 500, price: 3500 }, { max: Infinity, price: 3200 }] },
            { id: 'pc_pile', name: 'PC樁工程', content: 'PC樁放樣及打樁工程', unit: '支', inputType: 'quantity', payment: PAYMENT_PC_PILE, attachments: ATTACH_PC_PILE, pricing: [{ max: 50, price: 850 }, { max: 150, price: 800 }, { max: 499, price: 700 }, { max: Infinity, price: 650 }] },
            { id: 'ladder', name: '爬梯工程', content: '維修爬梯安裝工程', unit: '座', inputType: 'quantity', payment: PAYMENT_ONE_TIME, attachments: ATTACH_STD, pricing: [{ max: Infinity, price: 3500 }] },
            { id: 'contract_order', name: '承攬單/維修', content: '一般承攬工程', unit: '式', inputType: 'quantity', defaultPrice: 0, payment: PAYMENT_CONTRACT_ORDER, attachments: ATTACH_NONE },
            { id: 'module_flat', name: '模組(平舖)', content: '太陽能模組平舖鎖附工程', unit: 'KW', inputType: 'capacity', payment: PAYMENT_70_30, attachments: ATTACH_STD, pricing: [{ max: 50, price: 500 }, { max: 300, price: 450 }, { max: 500, price: 400 }, { max: Infinity, price: 400 }] }
        ];

        const DEFAULT_FORM = {
            id: '',
            typeId: 'machinery',
            projectName: '仁愛國小-124.16KW',
            capacity: '0',
            address: '台東縣台東市四維路一段400號',
            contractId: 'BV44893610',
            owner: '晶電能源系統股份有限公司',
            ownerLeader: '林碧麗',
            ownerTaxId: '64378445',
            ownerAddress: '台南市安平區國平里健康三街148號9F-1',
            contractor: '連聖傑工程行',
            contractorLeader: '張淑娟',
            contractorTaxId: '45604976',
            contractorAddress: '南投縣南投市軍功里東山路100號1樓',
            contactPerson: '廖烽傑',
            contractContent: '機房架設工程',
            signDate: '2025-10-27',
            startDate: '2025-10-17',
            endDate: '2025-10-20',
            unitPrice: '20000',
            quantity: '1',
            hSteelWeight: '0',
            cSteelWeight: '0',
            totalAmount: '20000',
            paymentTerms: PAYMENT_ONE_TIME,
            attachments: ATTACH_STD
        };

        const INITIAL_DB = [
            { ...DEFAULT_FORM, id: 1 }
        ];

        // ==========================================
        // Main App Component
        // ==========================================
        function App() {
            const [view, setView] = useState('dashboard');
            const [contracts, setContracts] = useState(INITIAL_DB);
            const [currentData, setCurrentData] = useState(DEFAULT_FORM);
            const [searchTerm, setSearchTerm] = useState('');
            
            const [ownerCompanies, setOwnerCompanies] = useState(OWNER_COMPANIES_DATA);
            const [contractorCompanies, setContractorCompanies] = useState(CONTRACTOR_COMPANIES_DATA);
            const [showAddCompanyModal, setShowAddCompanyModal] = useState({ show: false, type: '' });
            const [newCompany, setNewCompany] = useState({ name: '', leader: '', taxId: '', address: '', contact: '' });

            // --- 自動計算邏輯 ---
            useEffect(() => {
                if (view !== 'editor') return;
                const typeData = CONTRACT_TYPES.find(t => t.id === currentData.typeId);
                if (!typeData) return;

                let calculatedUnitPrice = currentData.unitPrice;
                let total = 0;
                let multiplier = 0;

                if (typeData.type === 'steel_weight') {
                    const h = parseFloat(currentData.hSteelWeight || 0);
                    const c = parseFloat(currentData.cSteelWeight || 0);
                    total = (h * 5) + (c * 4);
                    calculatedUnitPrice = "H鋼5元/C鋼4元";
                } else {
                    let inputVal = 0;
                    if (typeData.inputType === 'capacity') {
                        inputVal = parseFloat(currentData.capacity || 0);
                        multiplier = inputVal;
                    } else {
                        inputVal = parseFloat(currentData.quantity || 0);
                        multiplier = inputVal;
                    }

                    if (typeData.pricing) {
                        const tier = typeData.pricing.find(t => inputVal <= t.max);
                        if (tier) calculatedUnitPrice = tier.price.toString();
                    }
                    total = parseFloat(calculatedUnitPrice || 0) * multiplier;
                }

                setCurrentData(prev => {
                    const changes = {};
                    if (prev.totalAmount !== Math.round(total).toString()) changes.totalAmount = Math.round(total).toString();
                    if (typeData.pricing && prev.unitPrice !== calculatedUnitPrice) changes.unitPrice = calculatedUnitPrice;
                    return Object.keys(changes).length > 0 ? { ...prev, ...changes } : prev;
                });
            }, [currentData.capacity, currentData.quantity, currentData.hSteelWeight, currentData.cSteelWeight, currentData.typeId, view]);

            // --- CRUD Functions ---
            const handleCreate = () => { setCurrentData({ ...DEFAULT_FORM, id: Date.now() }); setView('editor'); };
            const handleEdit = (contract) => { setCurrentData(contract); setView('editor'); };
            const handleDelete = (id) => { if (confirm('確定要刪除此合約嗎？')) setContracts(contracts.filter(c => c.id !== id)); };
            const handleSave = () => {
                setContracts(prev => {
                    const idx = prev.findIndex(c => c.id === currentData.id);
                    return idx >= 0 ? prev.map((c, i) => i === idx ? currentData : c) : [...prev, currentData];
                });
                setView('dashboard');
            };
            const handleInput = (e) => setCurrentData({ ...currentData, [e.target.name]: e.target.value });
            
            const handleTypeChange = (e) => {
                const newTypeId = e.target.value;
                const typeData = CONTRACT_TYPES.find(t => t.id === newTypeId);
                if (typeData) {
                    setCurrentData(prev => ({
                        ...prev,
                        typeId: newTypeId,
                        contractContent: typeData.content,
                        unit: typeData.unit,
                        quantity: (typeData.inputType === 'quantity') ? '1' : prev.quantity,
                        paymentTerms: typeData.payment, 
                        attachments: typeData.attachments
                    }));
                }
            };

            const handleCompanyChange = (e, type) => {
                const selectedName = e.target.value;
                if (type === 'owner') {
                    const company = ownerCompanies.find(c => c.name === selectedName);
                    if (company) {
                        setCurrentData(prev => ({ ...prev, owner: company.name, ownerLeader: company.leader, ownerTaxId: company.taxId, ownerAddress: company.address }));
                    }
                } else {
                    const company = contractorCompanies.find(c => c.name === selectedName);
                    if (company) {
                        setCurrentData(prev => ({ ...prev, contractor: company.name, contractorLeader: company.leader, contractorTaxId: company.taxId, contractorAddress: company.address, contactPerson: company.contact || prev.contactPerson }));
                    }
                }
            };

            const handleAddCompany = () => {
                if (newCompany.name) {
                    if (showAddCompanyModal.type === 'owner') {
                        setOwnerCompanies([...ownerCompanies, newCompany]);
                    } else {
                        setContractorCompanies([...contractorCompanies, newCompany]);
                    }
                    setNewCompany({ name: '', leader: '', taxId: '', address: '', contact: '' });
                    setShowAddCompanyModal({ show: false, type: '' });
                }
            };

            const toROCDate = (dateStr) => {
                if (!dateStr) return "   年   月   日";
                const [y, m, d] = dateStr.split('-');
                return `${parseInt(y) - 1911}年${m}月${d}日`;
            };
            const toROCDateSpaced = (dateStr) => {
                if (!dateStr) return "   年   月   日";
                const [y, m, d] = dateStr.split('-');
                return ` ${parseInt(y) - 1911}  年  ${m}  月  ${d}  日`;
            };

            const editClass = "w-full p-2 border-2 border-red-200 rounded text-sm bg-red-50 focus:border-red-500 focus:bg-white transition-colors outline-none font-medium text-slate-800";
            const readOnlyClass = "w-full p-2 border border-slate-200 rounded text-sm bg-gray-100 text-gray-500 font-bold cursor-not-allowed";

            // --- Contract Preview Component ---
            const ContractPreview = ({ data }) => {
                const JustifiedLabel = ({ text, width = '5.5em' }) => (
                    <div style={{ width: width, display: 'flex', justifyContent: 'space-between', textAlignLast: 'justify', fontWeight: 'bold', flexShrink: 0 }}>
                    {text.split('').map((char, index) => <span key={index}>{char}</span>)}
                    </div>
                );
                const articles = [
                    { title: "一、工程內容：", content: `${data.contractContent}` },
                    { title: "二、工程容量：", content: `${data.capacity} KW` },
                    { title: "三、工程單價：", content: `新台幣 ${parseInt(data.unitPrice).toLocaleString()} 元 / ${CONTRACT_TYPES.find(t=>t.id===data.typeId)?.unit || ''}` },
                    { title: "四、工程總價：", content: `新台幣 ${parseInt(data.totalAmount).toLocaleString()} 元整 (未稅)。實作實算。` },
                    { title: "五、案場名稱：", content: `${data.projectName}`, subContent: `工程地點：${data.address}` }, 
                    { title: "六、付款辦法：", content: data.paymentTerms }, 
                    { title: "七、工程期限：", content: `本工程預定於 ${toROCDate(data.startDate).replace(/\s/g,'')} 開工，並於 ${toROCDate(data.endDate).replace(/\s/g,'')} 完工。乙方應依甲方核定之工程進度表施工。` },
                    { title: "八、工程圖說：", content: "乙方應依照設計圖說及施工規範施工，若圖說與現場情況不符，應即通知甲方釋疑。未經甲方同意，乙方不得擅自變更設計或施工方法。" },
                    { title: "九、施工管理：", content: "乙方應指派具備專業技能之工地負責人常駐現場，負責施工管理、人員調度及與甲方協調聯繫。施工期間應遵守甲方之門禁管制及工安規定。" },
                    { title: "十、監工與查驗：", content: "甲方得隨時派員監督施工及查驗材料，乙方應予配合。若發現施工品質不符規定，甲方得要求拆除重做，費用由乙方負擔，工期不得展延。" },
                    { title: "十一、工程變更：", content: "甲方對本工程有隨時變更計畫及增減工程數量之權，乙方不得異議。對於增減數量，雙方參照本合約所訂單價計算增減之。若有新增項目，由雙方協議合理單價。" },
                    { title: "十二、工程驗收：", content: "工程全部完工後，乙方應以書面通知甲方驗收。甲方應於接獲通知後七日內辦理初驗。驗收時若發現工程品質不符規定，乙方應於甲方指定期限內無償改善修正。" },
                    { title: "十三、保固責任：", content: "本工程自驗收合格日起，由乙方保固壹年。保固期間內，若因施工不良或材料瑕疵致發生損壞，乙方應於接獲通知後三日內派員修復，費用由乙方自行負擔。" },
                    { title: "十四、逾期罰則：", content: "乙方如未於規定期限內完工，每逾一日應按合約總價千分之一計算逾期違約金，甲方得自應付工程款中扣抵。" },
                    { title: "十五、勞工安全衛生：", content: "乙方於施工期間，應確實遵守「職業安全衛生法」及相關法令規定。若發生職業災害，概由乙方負完全責任。" },
                    { title: "十六、環境保護：", content: "乙方應遵守環境保護相關法令，施工期間應採取必要措施，防止噪音、揚塵及廢水污染環境。廢棄物應合法清運。" },
                    { title: "十七、風險分擔：", content: "工程未經驗收移交前，所有已完成之工程及存場材料，概由乙方負責保管。如有遺失或損壞，由乙方負責賠償或修復。" },
                    { title: "十八、保險：", content: "乙方應於施工期間投保營造綜合保險及雇主意外責任險，保險費用已包含於合約總價內。" },
                    { title: "十九、權利轉讓禁止：", content: "未經甲方書面同意，乙方不得將本合約之權利或義務轉讓予第三人，亦不得將工程轉包。" },
                    { title: "二十、違約處理：", content: "乙方若有違反本合約規定，經甲方通知限期改善而未改善者，甲方得終止合約。" },
                    { title: "二十一、合約終止：", content: "乙方若有無故停工達三日以上、工作能力薄弱顯難如期完工等情事，甲方得隨時終止或解除合約。" },
                    { title: "二十二、爭議處理：", content: "本合約若有未盡事宜，悉依中華民國相關法令辦理。甲乙雙方對本合約若有爭議，應本誠信原則協商解決，若協商不成涉訟時，雙方同意以臺灣臺南地方法院為第一審管轄法院。" }
                ];

                return (
                    <div className="bg-white shadow-none w-[210mm] min-h-[297mm] p-[20mm] print-area box-border font-serif">
                        <div className="contract-page flex flex-col justify-center min-h-[260mm] relative">
                            <div className="text-center mb-16">
                                <h1 className="text-3xl font-bold tracking-[0.5em] mb-8">工程施工承攬合約書</h1>
                                <div className="inline-block px-10 pb-1 border-b-[3px] border-black"><span className="text-2xl font-bold tracking-widest">{data.owner}</span></div>
                            </div>
                            <div className="w-[90%] mx-auto space-y-5 text-[13pt] font-medium font-sans">
                                {[ { label: '案　　　　　　場', val: data.projectName }, { label: '系　統　容　量　(KW)', val: data.capacity }, { label: '案　場　地　址', val: data.address }, { label: '工　程　編　號', val: data.contractId }, { label: '發　　包　　商', val: data.owner }, { label: '承　　攬　　商', val: data.contractor }, { label: '工　程　內　容', val: data.contractContent }, { label: '承　攬　商　負　責　人', val: data.contractorLeader }, { label: '工　地　聯　絡　人', val: data.contactPerson }, { label: '簽　約　日　期', val: toROCDate(data.signDate).replace(/\s/g,'') }].map((row, idx) => (
                                    <div key={idx} className="flex items-end group">
                                        <div style={{ width: '13em', textAlignLast: 'justify', textAlign: 'justify', marginRight: '0.5em', fontWeight: 'bold' }}>{row.label}</div>
                                        <div className="font-bold mr-2">：</div>
                                        <div className="flex-grow border-b border-black border-solid pb-1 px-2 font-bold whitespace-nowrap overflow-hidden">{row.val}</div>
                                    </div>
                                ))}
                            </div>
                            <div className="absolute bottom-0 w-full text-center text-sm text-gray-400 italic no-print">(第 1 頁 - 封面)</div>
                        </div>
                        
                        <div className="contract-page min-h-[260mm] flex flex-col pt-16">
                            <div className="text-center mb-10">
                                <h1 className="text-3xl font-bold tracking-[0.5em] mb-8">工程合約書</h1>
                                <div className="inline-block px-10 pb-1 border-b-[3px] border-black"><span className="text-2xl font-bold tracking-widest">{data.owner}</span></div>
                            </div>
                            <div className="space-y-6 text-[12pt] leading-relaxed text-justify">
                                <div className="mb-8 font-bold space-y-2">
                                    <p>業　主（下簡稱甲方）：{data.owner}</p>
                                    <p>承包商（下簡稱乙方）：{data.contractor}</p>
                                    <p>經雙方同意訂立本合約其條款如下：</p>
                                </div>
                                {articles.slice(0, 10).map((art, idx) => (
                                    <div key={idx}>
                                        <h3 className="font-bold mb-1">{art.title}</h3>
                                        {art.subContent ? <div className="indent-8 pl-2"><p>{art.content}</p><p>{art.subContent}</p></div> : <p className="indent-8 whitespace-pre-line pl-2">{art.content}</p>}
                                    </div>
                                ))}
                            </div>
                            <div className="mt-auto text-center text-sm text-gray-400 italic no-print">(第 2 頁)</div>
                        </div>

                        <div className="contract-page min-h-[260mm] flex flex-col pt-16">
                            <div className="space-y-6 text-[12pt] leading-relaxed text-justify">
                                {articles.slice(10).map((art, idx) => (
                                    <div key={idx}>
                                        <h3 className="font-bold mb-1">{art.title}</h3>
                                        <p className="indent-8 whitespace-pre-line pl-2">{art.content}</p>
                                    </div>
                                ))}
                            </div>
                            <div className="mt-12 mb-4 pt-4 border-t-2 border-black flex flex-row gap-8">
                                {[{ roleTitle: '甲 方', name: data.owner, leader: data.ownerLeader, taxId: data.ownerTaxId, addr: data.ownerAddress, boxText: '甲方用印處' },
                                    { roleTitle: '乙 方', name: data.contractor, leader: data.contractorLeader, taxId: data.contractorTaxId, addr: data.contractorAddress, boxText: '乙方用印處' }
                                ].map((p, idx) => (
                                    <div key={idx} className="flex-1 flex flex-col">
                                        <div className="font-bold text-xl mb-4 border-b border-black pb-1 pl-2">{p.roleTitle}：</div>
                                        <div className="space-y-3 flex-grow text-[11pt] px-2">
                                            {[ { l: '公 司', v: p.name }, { l: '負 責 人', v: p.leader }, { l: '統 一 編 號', v: p.taxId }, { l: '地 址', v: p.addr } ].map((row, rIdx) => (
                                                <div key={rIdx} className="flex items-start">
                                                    <JustifiedLabel text={row.l} />
                                                    <span className="font-bold mx-1">：</span>
                                                    <span className="font-bold whitespace-nowrap overflow-hidden text-ellipsis">{row.v}</span>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="h-28 mt-8 bg-gray-300 rounded-lg border border-gray-300 flex items-center justify-center text-gray-500 font-bold tracking-widest text-xl shadow-inner">{p.boxText}</div>
                                    </div>
                                ))}
                            </div>
                            <div className="text-center mt-8 mb-12 font-bold text-xl tracking-[0.3em]">中 華 民 國 {toROCDateSpaced(data.signDate).replace(/年|月|日/g, (m) => ` ${m} `)}</div>
                            <div className="mt-auto text-center text-sm text-gray-400 italic no-print">(第 3 頁)</div>
                        </div>

                        <div className="contract-page min-h-[260mm] flex flex-col justify-center px-4">
                            <div className="text-center mb-10">
                                <h2 className="text-3xl font-bold tracking-[0.2em] inline-block border-b-[3px] border-black pb-2">承攬工程合約附件簽收書</h2>
                            </div>
                            <div className="text-[13pt] leading-loose px-8 mx-auto">
                                <p className="mb-4 text-justify">立簽收書人 <span className="font-bold border-b border-black px-2">{data.contractor}</span> (承攬人) 承攬 <span className="font-bold border-b border-black px-2">{data.owner}</span> (定作人) 之「<span className="font-bold border-b border-black px-2">{data.projectName}</span>」工程。</p>
                                <p className="mt-6 mb-4 font-bold">定作人已將本工程之合約附件，交付予簽收人，附件清單如下：</p>
                                <ul className="ml-8 space-y-2 font-bold">
                                    {data.attachments && data.attachments.map((item, idx) => <li key={idx}>□ {item}</li>)}
                                </ul>
                                <p className="mt-12 font-bold text-lg text-center">※ 立簽收書人未來不得以合約未具附件為訴訟及抗辯之理由。</p>
                                <div className="mt-16 flex justify-end">
                                    <div className="w-[45%]">
                                        <div className="mb-8 border-b border-black pb-1 flex justify-between items-end"><span className="font-bold text-lg">簽收人(乙方)簽章：</span><span></span></div>
                                        <div className="border-b border-black pb-1 flex justify-between items-end"><span className="font-bold text-lg">日　期：</span><span className="text-lg font-bold">{toROCDate(data.signDate).replace(/年|月|日/g, (m) => ` ${m} `)}</span></div>
                                    </div>
                                </div>
                            </div>
                            <div className="mt-auto text-center text-sm text-gray-400 italic no-print">(第 4 頁 - 附件)</div>
                        </div>
                    </div>
                );
            };

            // --- Views ---

            const DashboardView = () => (
                <div className="p-8 max-w-7xl mx-auto no-print">
                    <div className="flex justify-between items-end mb-8">
                        <div><h1 className="text-3xl font-bold text-slate-800">工程合約管理系統</h1></div>
                        <button onClick={handleCreate} className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-blue-700 transition shadow-lg"><Plus /> 新增合約</button>
                    </div>
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="p-4 border-b border-slate-100"><input className="w-full p-2 border rounded-lg" placeholder="搜尋..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                        <table className="w-full text-left">
                            <thead className="bg-slate-50 text-slate-500 font-bold"><tr><th className="px-6 py-4">案場</th><th className="px-6 py-4">內容</th><th className="px-6 py-4">承攬商</th><th className="px-6 py-4 text-right">金額</th><th className="px-6 py-4 text-center">操作</th></tr></thead>
                            <tbody className="divide-y divide-slate-100">
                                {contracts.filter(c => c.projectName.includes(searchTerm)).map(c => (
                                    <tr key={c.id} className="hover:bg-slate-50"><td className="px-6 py-4 font-bold">{c.projectName}</td><td className="px-6 py-4">{c.contractContent}</td><td className="px-6 py-4">{c.contractor}</td><td className="px-6 py-4 text-right font-mono">${parseInt(c.totalAmount).toLocaleString()}</td><td className="px-6 py-4 flex justify-center gap-2"><button onClick={() => { setCurrentData(c); setView('preview'); }} className="p-2 text-blue-600"><Eye size={18}/></button><button onClick={() => handleEdit(c)} className="p-2 text-slate-600"><Edit size={18}/></button><button onClick={() => handleDelete(c.id)} className="p-2 text-red-400"><Trash2 size={18}/></button></td></tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            const EditorView = () => (
                <div className="flex h-screen bg-slate-50 no-print">
                    <div className="w-[400px] bg-white border-r border-slate-200 overflow-y-auto p-6 shadow-xl z-10 flex flex-col">
                        <div className="flex items-center justify-between mb-6"><h2 className="font-bold text-xl">編輯合約</h2><button onClick={() => setView('dashboard')}><ArrowLeft size={20}/></button></div>
                        <div className="space-y-4 flex-1">
                            <label className="text-xs font-bold text-slate-500">工程類型</label>
                            <select className="w-full p-2 border rounded-lg" value={currentData.typeId} onChange={handleTypeChange}>{CONTRACT_TYPES.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select>
                            
                            <div className="space-y-4 pt-4 border-t border-gray-100">
                                <h3 className="font-bold text-sm text-red-600 flex items-center gap-2"><LayoutTemplate size={16}/> 案場基本資料 (必填)</h3>
                                <input name="projectName" placeholder="案場名稱" value={currentData.projectName} onChange={handleInput} className={editClass} />
                                <div className="grid grid-cols-2 gap-2">
                                    <input name="capacity" placeholder="容量(KW)" value={currentData.capacity} onChange={handleInput} className={editClass} />
                                    <input name="contractId" placeholder="編號" value={currentData.contractId} onChange={handleInput} className={editClass} />
                                </div>
                                <input name="address" placeholder="地址" value={currentData.address} onChange={handleInput} className={editClass} />
                            </div>

                            <div className="space-y-4 pt-4 border-t border-gray-100">
                                <h3 className="font-bold text-sm text-red-600">甲乙雙方資訊 (必填)</h3>
                                <div className="space-y-2">
                                    <label className="text-[10px] text-gray-400 font-bold uppercase flex justify-between">甲方 (發包商) <button onClick={() => setShowAddCompanyModal({show: true, type: 'owner'})} className="text-blue-600 hover:underline">+ 新增</button></label>
                                    <div className="relative">
                                        <select name="owner" value={currentData.owner} onChange={(e) => handleCompanyChange(e, 'owner')} className={editClass + " appearance-none"}>
                                            <option value="" disabled>請選擇甲方公司</option>
                                            {ownerCompanies.map(c => <option key={c.taxId} value={c.name}>{c.name}</option>)}
                                        </select>
                                        <div className="absolute right-2 top-3 text-red-400 pointer-events-none"><ChevronDown size={16}/></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input name="ownerLeader" placeholder="負責人" value={currentData.ownerLeader} onChange={handleInput} className={editClass} />
                                        <input name="ownerTaxId" placeholder="統編" value={currentData.ownerTaxId} onChange={handleInput} className={editClass} />
                                    </div>
                                    <input name="ownerAddress" placeholder="地址" value={currentData.ownerAddress} onChange={handleInput} className={editClass} />
                                </div>
                                <div className="space-y-2 pt-2">
                                    <label className="text-[10px] text-gray-400 font-bold uppercase flex justify-between">乙方 (承攬商) <button onClick={() => setShowAddCompanyModal({show: true, type: 'contractor'})} className="text-blue-600 hover:underline">+ 新增</button></label>
                                    <div className="relative">
                                        <select name="contractor" value={currentData.contractor} onChange={(e) => handleCompanyChange(e, 'contractor')} className={editClass + " appearance-none"}>
                                            <option value="" disabled>請選擇乙方公司</option>
                                            {contractorCompanies.map(c => <option key={c.taxId} value={c.name}>{c.name}</option>)}
                                        </select>
                                        <div className="absolute right-2 top-3 text-red-400 pointer-events-none"><ChevronDown size={16}/></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input name="contractorLeader" placeholder="負責人" value={currentData.contractorLeader} onChange={handleInput} className={editClass} />
                                        <input name="contractorTaxId" placeholder="統編" value={currentData.contractorTaxId} onChange={handleInput} className={editClass} />
                                    </div>
                                    <input name="contractorAddress" placeholder="地址" value={currentData.contractorAddress} onChange={handleInput} className={editClass} />
                                    <input name="contactPerson" placeholder="工地聯絡人" value={currentData.contactPerson} onChange={handleInput} className={editClass} />
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-2"><input name="unitPrice" className={readOnlyClass} readOnly value={currentData.unitPrice} /><input name="quantity" className={editClass} value={currentData.quantity} onChange={handleInput} /></div>
                            <input name="totalAmount" className={readOnlyClass} readOnly value={currentData.totalAmount} />
                            <div className="space-y-1 pt-4 border-t border-dashed">
                                <label className="text-[10px] text-gray-400 font-bold flex items-center gap-1"><AlertCircle size={10}/> 付款辦法 (自動帶入)</label>
                                <textarea name="paymentTerms" value={currentData.paymentTerms} onChange={handleInput} className="w-full h-40 p-2 border rounded text-sm font-mono leading-relaxed" />
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <input type="date" name="startDate" className={editClass} value={currentData.startDate} onChange={handleInput} />
                                <input type="date" name="endDate" className={editClass} value={currentData.endDate} onChange={handleInput} />
                            </div>
                            <input type="date" name="signDate" className={editClass} value={currentData.signDate} onChange={handleInput} />
                        </div>
                        <div className="pt-4 border-t"><button onClick={handleSave} className="w-full bg-slate-900 text-white py-3 rounded-lg font-bold flex justify-center gap-2"><Save size={18}/> 儲存</button></div>
                    </div>
                    <div className="flex-1 bg-white overflow-y-auto p-8 flex justify-center"><ContractPreview data={currentData} /></div>

                    {/* 新增公司 Modal */}
                    {showAddCompanyModal.show && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-xl shadow-xl w-96">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold flex items-center gap-2"><Building size={20}/> 新增{showAddCompanyModal.type === 'owner' ? '甲方' : '乙方'}公司</h3>
                                    <button onClick={() => setShowAddCompanyModal({show: false, type: ''})}><X size={20}/></button>
                                </div>
                                <div className="space-y-3">
                                    <input placeholder="公司名稱" className="w-full p-2 border rounded" value={newCompany.name} onChange={e => setNewCompany({...newCompany, name: e.target.value})} />
                                    <input placeholder="負責人" className="w-full p-2 border rounded" value={newCompany.leader} onChange={e => setNewCompany({...newCompany, leader: e.target.value})} />
                                    <input placeholder="統一編號" className="w-full p-2 border rounded" value={newCompany.taxId} onChange={e => setNewCompany({...newCompany, taxId: e.target.value})} />
                                    <input placeholder="公司地址" className="w-full p-2 border rounded" value={newCompany.address} onChange={e => setNewCompany({...newCompany, address: e.target.value})} />
                                    {showAddCompanyModal.type === 'contractor' && <input placeholder="聯絡人" className="w-full p-2 border rounded" value={newCompany.contact} onChange={e => setNewCompany({...newCompany, contact: e.target.value})} />}
                                </div>
                                <div className="flex gap-2 mt-6">
                                    <button onClick={() => setShowAddCompanyModal({show: false, type: ''})} className="flex-1 p-2 bg-gray-100 rounded text-gray-600 font-bold">取消</button>
                                    <button onClick={handleAddCompany} className="flex-1 p-2 bg-blue-600 text-white rounded font-bold">新增</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );

            const PreviewView = () => (
                <div className="min-h-screen bg-white flex flex-col">
                    <div className="bg-white p-4 shadow flex justify-between items-center no-print">
                        <h1 className="font-bold text-xl">合約預覽</h1>
                        <div className="flex gap-4">
                            <button onClick={() => setView('editor')} className="px-4 py-2 rounded bg-gray-100 hover:bg-gray-200 font-bold">返回編輯</button>
                            <button onClick={() => window.print()} className="px-4 py-2 rounded bg-slate-900 text-white hover:bg-black font-bold flex items-center gap-2"><Printer size={18}/> 列印</button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-auto p-8 flex justify-center print:p-0">
                        <ContractPreview data={currentData} />
                    </div>
                </div>
            );

            // Routing
            return view === 'dashboard' ? <DashboardView /> : (view === 'editor' ? <EditorView /> : <PreviewView />);
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>